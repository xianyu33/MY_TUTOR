<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yy.my_tutor.test.mapper.TestAnalysisReportMapper">

    <resultMap id="BaseResultMap" type="com.yy.my_tutor.test.domain.TestAnalysisReport">
        <id column="id" property="id"/>
        <result column="test_record_id" property="testRecordId"/>
        <result column="student_id" property="studentId"/>
        <result column="test_id" property="testId"/>
        <result column="report_type" property="reportType"/>
        <result column="report_title" property="reportTitle"/>
        <result column="report_content" property="reportContent"/>
        <result column="file_path" property="filePath"/>
        <result column="file_size" property="fileSize"/>
        <result column="download_count" property="downloadCount"/>
        <result column="analysis_data" property="analysisData"/>
        <result column="create_at" property="createAt"/>
        <result column="create_by" property="createBy"/>
        <result column="update_at" property="updateAt"/>
        <result column="update_by" property="updateBy"/>
        <result column="delete_flag" property="deleteFlag"/>
    </resultMap>

    <sql id="Base_Columns">
        id, test_record_id, student_id, test_id, report_type, report_title, report_content,
        file_path, file_size, download_count, analysis_data, create_at, create_by,
        update_at, update_by, delete_flag
    </sql>

    <select id="findReportsByStudentId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Columns"/>
        FROM test_analysis_report
        WHERE student_id = #{studentId} AND delete_flag = 'N'
        ORDER BY create_at DESC
    </select>

    <select id="findReportsByTestRecordId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Columns"/>
        FROM test_analysis_report
        WHERE test_record_id = #{testRecordId} AND delete_flag = 'N'
        ORDER BY create_at DESC
    </select>

    <select id="findReportByRecordAndType" resultMap="BaseResultMap">
        SELECT <include refid="Base_Columns"/>
        FROM test_analysis_report
        WHERE test_record_id = #{testRecordId} AND report_type = #{reportType} AND delete_flag = 'N'
        LIMIT 1
    </select>

    <insert id="insertAnalysisReport" parameterType="com.yy.my_tutor.test.domain.TestAnalysisReport" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO test_analysis_report (test_record_id, student_id, test_id, report_type, report_title,
                                         report_content, file_path, file_size, download_count, analysis_data,
                                         create_at, create_by, update_at, update_by, delete_flag)
        VALUES (#{testRecordId}, #{studentId}, #{testId}, #{reportType}, #{reportTitle},
                #{reportContent}, #{filePath}, #{fileSize}, #{downloadCount}, #{analysisData},
                NOW(), #{createBy}, NOW(), #{updateBy}, 'N')
    </insert>

    <update id="updateAnalysisReport" parameterType="com.yy.my_tutor.test.domain.TestAnalysisReport">
        UPDATE test_analysis_report
        SET report_title = #{reportTitle},
            report_content = #{reportContent},
            file_path = #{filePath},
            file_size = #{fileSize},
            analysis_data = #{analysisData},
            update_at = NOW(),
            update_by = #{updateBy}
        WHERE id = #{id} AND delete_flag = 'N'
    </update>

    <update id="updateDownloadCount">
        UPDATE test_analysis_report
        SET download_count = download_count + 1, update_at = NOW()
        WHERE id = #{id} AND delete_flag = 'N'
    </update>

    <update id="deleteAnalysisReport">
        UPDATE test_analysis_report
        SET delete_flag = 'Y', update_at = NOW()
        WHERE id = #{id}
    </update>

</mapper>
