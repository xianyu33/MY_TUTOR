<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yy.my_tutor.user.mapper.GuardianStudentRelMapper">

    <resultMap id="BaseResultMap" type="com.yy.my_tutor.user.domain.GuardianStudentRel">
        <id column="id" property="id"/>
        <result column="guardian_id" property="guardianId"/>
        <result column="guardian_type" property="guardianType"/>
        <result column="student_id" property="studentId"/>
        <result column="relation" property="relation"/>
        <result column="start_at" property="startAt"/>
        <result column="end_at" property="endAt"/>
        <result column="create_at" property="createAt"/>
        <result column="create_by" property="createBy"/>
        <result column="update_at" property="updateAt"/>
        <result column="update_by" property="updateBy"/>
        <result column="delete_flag" property="deleteFlag"/>
    </resultMap>

    <sql id="Base_Columns">
        id, guardian_id, guardian_type, student_id, relation, start_at, end_at,
        create_at, create_by, update_at, update_by, delete_flag
    </sql>

    <select id="findByGuardian" resultMap="BaseResultMap">
        SELECT <include refid="Base_Columns"/>
        FROM guardian_student_rel
        WHERE guardian_id = #{guardianId}
          AND guardian_type = #{guardianType}
          AND delete_flag = '0'
        ORDER BY create_at DESC
    </select>

    <select id="findByStudent" resultMap="BaseResultMap">
        SELECT <include refid="Base_Columns"/>
        FROM guardian_student_rel
        WHERE student_id = #{studentId}
          AND delete_flag = '0'
        ORDER BY create_at DESC
    </select>

    <select id="findUnique" resultMap="BaseResultMap">
        SELECT <include refid="Base_Columns"/>
        FROM guardian_student_rel
        WHERE guardian_id = #{guardianId}
          AND student_id = #{studentId}
          AND delete_flag = '0'
        LIMIT 1
    </select>

    <insert id="insert" parameterType="com.yy.my_tutor.user.domain.GuardianStudentRel" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO guardian_student_rel
        (guardian_id, guardian_type, student_id, relation, start_at, end_at, create_at, create_by, update_at, update_by, delete_flag)
        VALUES
        (#{guardianId}, #{guardianType}, #{studentId}, #{relation}, #{startAt}, #{endAt}, NOW(), #{createBy}, NOW(), #{updateBy}, '0')
    </insert>

    <update id="update" parameterType="com.yy.my_tutor.user.domain.GuardianStudentRel">
        UPDATE guardian_student_rel
        SET relation = #{relation},
            start_at = #{startAt},
            end_at = #{endAt},
            update_at = NOW(),
            update_by = #{updateBy}
        WHERE id = #{id}
          AND delete_flag = '0'
    </update>

    <update id="logicalDelete">
        UPDATE guardian_student_rel
        SET delete_flag = '1', update_at = NOW()
        WHERE id = #{id}
    </update>

</mapper>


