<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yy.my_tutor.math.mapper.QuestionMapper">

    <resultMap id="BaseResultMap" type="com.yy.my_tutor.math.domain.Question">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="knowledge_point_id" property="knowledgePointId" jdbcType="INTEGER"/>
        <result column="question_type" property="questionType" jdbcType="TINYINT"/>
        <result column="question_title" property="questionTitle" jdbcType="VARCHAR"/>
        <result column="question_title_fr" property="questionTitleFr" jdbcType="VARCHAR"/>
        <result column="question_content" property="questionContent" jdbcType="VARCHAR"/>
        <result column="question_content_fr" property="questionContentFr" jdbcType="VARCHAR"/>
        <result column="options" property="options" jdbcType="VARCHAR"/>
        <result column="options_fr" property="optionsFr" jdbcType="VARCHAR"/>
        <result column="correct_answer" property="correctAnswer" jdbcType="VARCHAR"/>
        <result column="correct_answer_fr" property="correctAnswerFr" jdbcType="VARCHAR"/>
        <result column="answer_explanation" property="answerExplanation" jdbcType="VARCHAR"/>
        <result column="answer_explanation_fr" property="answerExplanationFr" jdbcType="VARCHAR"/>
        <result column="difficulty_level" property="difficultyLevel" jdbcType="TINYINT"/>
        <result column="points" property="points" jdbcType="INTEGER"/>
        <result column="sort_order" property="sortOrder" jdbcType="INTEGER"/>
        <result column="create_at" property="createAt" jdbcType="TIMESTAMP"/>
        <result column="create_by" property="createBy" jdbcType="VARCHAR"/>
        <result column="update_at" property="updateAt" jdbcType="TIMESTAMP"/>
        <result column="update_by" property="updateBy" jdbcType="VARCHAR"/>
        <result column="delete_flag" property="deleteFlag" jdbcType="CHAR"/>
        <result column="generation_source" property="generationSource" jdbcType="VARCHAR"/>
        <result column="model_id" property="modelId" jdbcType="VARCHAR"/>
        <result column="prompt_used" property="promptUsed" jdbcType="LONGVARCHAR"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, knowledge_point_id, question_type, question_title, question_title_fr, question_content, question_content_fr,
        options, options_fr, correct_answer, correct_answer_fr, answer_explanation, answer_explanation_fr,
        difficulty_level, points, sort_order, create_at, create_by, update_at, update_by, delete_flag,
        generation_source, model_id, prompt_used
    </sql>

    <select id="findAllQuestions" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM question
        WHERE delete_flag = 'N'
        ORDER BY knowledge_point_id, sort_order ASC
    </select>

    <select id="findQuestionById" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM question
        WHERE id = #{id} AND delete_flag = 'N'
    </select>

    <select id="findQuestionsByKnowledgePointId" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM question
        WHERE knowledge_point_id = #{knowledgePointId} AND delete_flag = 'N'
        ORDER BY sort_order ASC
    </select>

    <select id="findQuestionsByType" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM question
        WHERE question_type = #{questionType} AND delete_flag = 'N'
        ORDER BY knowledge_point_id, sort_order ASC
    </select>

    <select id="findQuestionsByDifficulty" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM question
        WHERE difficulty_level = #{difficultyLevel} AND delete_flag = 'N'
        ORDER BY knowledge_point_id, sort_order ASC
    </select>

    <select id="findQuestionsByKnowledgeAndDifficulty" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM question
        WHERE knowledge_point_id = #{knowledgePointId} AND difficulty_level = #{difficultyLevel} AND delete_flag = 'N'
        ORDER BY sort_order ASC
    </select>

    <select id="findRandomQuestions" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM question
        WHERE knowledge_point_id = #{knowledgePointId} AND delete_flag = 'N'
        ORDER BY RAND()
        LIMIT #{limit}
    </select>

    <select id="findRandomQuestionsByGradeAndDifficulty" resultMap="BaseResultMap">
        SELECT
            q.id, q.knowledge_point_id, q.question_type, q.question_title, q.question_title_fr, q.question_content, q.question_content_fr,
            q.options, q.options_fr, q.correct_answer, q.correct_answer_fr, q.answer_explanation, q.answer_explanation_fr,
            q.difficulty_level, q.points, q.sort_order, q.create_at, q.create_by, q.update_at, q.update_by, q.delete_flag
        FROM question q
        INNER JOIN knowledge_point kp ON q.knowledge_point_id = kp.id
        WHERE kp.grade_id = #{gradeId}
        AND q.difficulty_level = #{difficultyLevel}
        AND q.delete_flag = 'N'
        AND kp.delete_flag = 'N'
        ORDER BY RAND()
        LIMIT #{limit}
    </select>

    <select id="findQuestionsByGradeCategoryAndDifficulty" resultMap="BaseResultMap">
        SELECT
            q.id, q.knowledge_point_id, q.question_type, q.question_title, q.question_title_fr, q.question_content, q.question_content_fr,
            q.options, q.options_fr, q.correct_answer, q.correct_answer_fr, q.answer_explanation, q.answer_explanation_fr,
            q.difficulty_level, q.points, q.sort_order, q.create_at, q.create_by, q.update_at, q.update_by, q.delete_flag
        FROM question q
        INNER JOIN knowledge_point kp ON q.knowledge_point_id = kp.id
        WHERE kp.grade_id = #{gradeId}
        AND q.delete_flag = 'N'
        AND kp.delete_flag = 'N'
        <if test="categoryIds != null and categoryIds.size() > 0">
            AND kp.category_id IN
            <foreach collection="categoryIds" item="categoryId" open="(" separator="," close=")">
                #{categoryId}
            </foreach>
        </if>
        <if test="difficultyLevel != null">
            AND q.difficulty_level = #{difficultyLevel}
        </if>
        ORDER BY RAND()
    </select>

    <select id="findQuestionsByKnowledgePointIdsAndDifficulty" resultMap="BaseResultMap">
        SELECT
            <include refid="Base_Column_List"/>
        FROM question
        WHERE delete_flag = 'N'
        <if test="knowledgePointIds != null and knowledgePointIds.size() > 0">
            AND knowledge_point_id IN
            <foreach collection="knowledgePointIds" item="knowledgePointId" open="(" separator="," close=")">
                #{knowledgePointId}
            </foreach>
        </if>
        <if test="difficultyLevel != null">
            AND difficulty_level = #{difficultyLevel}
        </if>
        ORDER BY RAND()
    </select>

    <select id="findQuestionsByGradeCategoryAndDifficultyLevel" resultMap="BaseResultMap">
        SELECT
            q.id, q.knowledge_point_id, q.question_type, q.question_title, q.question_title_fr, q.question_content, q.question_content_fr,
            q.options, q.options_fr, q.correct_answer, q.correct_answer_fr, q.answer_explanation, q.answer_explanation_fr,
            q.difficulty_level, q.points, q.sort_order, q.create_at, q.create_by, q.update_at, q.update_by, q.delete_flag
        FROM question q
        INNER JOIN knowledge_point kp ON q.knowledge_point_id = kp.id
        WHERE kp.grade_id = #{gradeId}
        AND kp.category_id = #{categoryId}
        AND q.difficulty_level = #{difficultyLevel}
        AND q.delete_flag = 'N'
        AND kp.delete_flag = 'N'
        ORDER BY RAND()
    </select>

    <insert id="insertQuestion" parameterType="com.yy.my_tutor.math.domain.Question" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO question (knowledge_point_id, question_type, question_title, question_title_fr,
                             question_content, question_content_fr, options, options_fr,
                             correct_answer, correct_answer_fr, answer_explanation, answer_explanation_fr,
                             difficulty_level, points, sort_order, generation_source, model_id, prompt_used,
                             create_at, create_by, update_at, update_by, delete_flag)
        VALUES (#{knowledgePointId}, #{questionType}, #{questionTitle}, #{questionTitleFr},
                #{questionContent}, #{questionContentFr}, #{options}, #{optionsFr},
                #{correctAnswer}, #{correctAnswerFr}, #{answerExplanation}, #{answerExplanationFr},
                #{difficultyLevel}, #{points}, #{sortOrder}, #{generationSource}, #{modelId}, #{promptUsed},
                NOW(), #{createBy}, NOW(), #{updateBy}, 'N')
    </insert>

    <update id="updateQuestion" parameterType="com.yy.my_tutor.math.domain.Question">
        UPDATE question
        SET knowledge_point_id = #{knowledgePointId},
            question_type = #{questionType},
            question_title = #{questionTitle},
            question_content = #{questionContent},
            options = #{options},
            correct_answer = #{correctAnswer},
            answer_explanation = #{answerExplanation},
            difficulty_level = #{difficultyLevel},
            points = #{points},
            sort_order = #{sortOrder},
            update_at = NOW(),
            update_by = #{updateBy}
        WHERE id = #{id} AND delete_flag = 'N'
    </update>

    <update id="deleteQuestion" parameterType="java.lang.Integer">
        UPDATE question
        SET delete_flag = 'Y',
            update_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- 查询学生未做过的题目（根据知识点和难度） -->
    <select id="findUndoneQuestionsByKnowledgePoint" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM question
        WHERE knowledge_point_id = #{knowledgePointId}
        AND delete_flag = 'N'
        <if test="difficultyLevel != null">
            AND difficulty_level = #{difficultyLevel}
        </if>
        <if test="doneQuestionIds != null and doneQuestionIds.size() > 0">
            AND id NOT IN
            <foreach collection="doneQuestionIds" item="questionId" open="(" separator="," close=")">
                #{questionId}
            </foreach>
        </if>
        ORDER BY RAND()
    </select>

    <!-- 查询学生未做过的题目（根据多个知识点和难度） -->
    <select id="findUndoneQuestionsByKnowledgePoints" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM question
        WHERE delete_flag = 'N'
        <if test="knowledgePointIds != null and knowledgePointIds.size() > 0">
            AND knowledge_point_id IN
            <foreach collection="knowledgePointIds" item="kpId" open="(" separator="," close=")">
                #{kpId}
            </foreach>
        </if>
        <if test="difficultyLevel != null">
            AND difficulty_level = #{difficultyLevel}
        </if>
        <if test="doneQuestionIds != null and doneQuestionIds.size() > 0">
            AND id NOT IN
            <foreach collection="doneQuestionIds" item="questionId" open="(" separator="," close=")">
                #{questionId}
            </foreach>
        </if>
        ORDER BY RAND()
    </select>

</mapper>
