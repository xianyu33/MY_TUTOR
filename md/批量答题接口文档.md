# 批量答题接口文档

## 接口说明

**接口地址**: `POST /api/student-test/batch-submit`

**功能说明**: 学生批量提交答案，系统自动计算得分、统计各知识点得分情况，并生成分析报告（strong/needs improvement/weak）

## 请求参数

```json
{
  "testRecordId": 1001,
  "studentId": 123,
  "answers": [
    {
      "questionId": 501,
      "studentAnswer": "C",
      "timeSpent": 30
    },
    {
      "questionId": 502,
      "studentAnswer": "A",
      "timeSpent": 45
    },
    {
      "questionId": 503,
      "studentAnswer": "B",
      "timeSpent": 25
    }
  ]
}
```

### 参数说明

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| testRecordId | Integer | 是 | 测试记录ID |
| studentId | Integer | 是 | 学生ID |
| answers | List | 是 | 答题列表 |
| answers[].questionId | Integer | 是 | 题目ID |
| answers[].studentAnswer | String | 是 | 学生答案 |
| answers[].timeSpent | Integer | 否 | 答题用时（秒） |

## 响应示例

```json
{
  "code": 200,
  "message": "提交成功并生成分析报告",
  "data": {
    "testRecordId": 1001,
    "studentId": 123,
    "testId": 5001,
    "totalPoints": 30,
    "earnedPoints": 24,
    "scoreRate": 80.00,
    "accuracyRate": 83.33,
    "totalQuestions": 30,
    "correctAnswers": 25,
    "overallComment": "表现优秀！",
    "overallCommentFr": "Excellent travail !",
    
    "knowledgePointScores": [
      {
        "knowledgePointId": 1,
        "knowledgePointName": "Triangles",
        "knowledgePointNameFr": "Triangles",
        "totalPoints": 10,
        "earnedPoints": 9,
        "scoreRate": 90.00,
        "questionCount": 5,
        "correctCount": 4
      },
      {
        "knowledgePointId": 15,
        "knowledgePointName": "Linear Functions",
        "knowledgePointNameFr": "Fonctions linéaires",
        "totalPoints": 20,
        "earnedPoints": 15,
        "scoreRate": 75.00,
        "questionCount": 10,
        "correctCount": 8
      }
    ],
    
    "knowledgePointAnalysis": {
      "strongPoints": [1, 5, 9],
      "needsImprovementPoints": [15, 16],
      "weakPoints": [22],
      
      "strongSummary": "Triangles, Quadratic Radicals, Pythagorean Theorem",
      "needsImprovementSummary": "Linear Functions, Graphs of Linear Functions",
      "weakSummary": "Applications of Linear Functions"
    },
    
    "recommendations": "总体得分: 80.00%\n\n掌握较好: Triangles, Quadratic Radicals\n需要改进: Linear Functions\n薄弱环节: Applications of Linear Functions",
    "recommendationsFr": "总总体得分: 80.00%\n\n掌握较好: Triangles, Quadratic Radicals\n需要改进: Linear Functions\n薄弱环节: Applications of Linear Functions",
    
    "createAt": "2023-12-21 15:30:00"
  }
}
```

## 响应字段说明

### 测试基本信息
- `testRecordId`: 测试记录ID
- `studentId`: 学生ID
- `testId`: 测试ID
- `totalPoints`: 总分
- `earnedPoints`: 获得分数
- `scoreRate`: 得分率（百分比）
- `accuracyRate`: 正确率（百分比）
- `totalQuestions`: 总题目数
- `correctAnswers`: 正确答案数
- `overallComment`: 总体评价
- `overallCommentFr`: 总体评价（法语）

### 知识点得分统计
- `knowledgePointScores`: 各知识点得分列表
  - `knowledgePointId`: 知识点ID
  - `knowledgePointName`: 知识点名称
  - `knowledgePointNameFr`: 知识点名称（法语）
  - `totalPoints`: 总分
  - `earnedPoints`: 获得分数
  - `scoreRate`: 得分率
  - `questionCount`: 题目数量
  - `correctCount`: 正确数量

### 知识点分析
- `strongPoints`: 掌握较好的知识点ID列表（得分率 >= 80%）
- `needsImprovementPoints`: 需要改进的知识点ID列表（得分率 50%-80%）
- `weakPoints`: 薄弱知识点ID列表（得分率 < 50%）
- `strongSummary`: 掌握较好的知识点摘要
- `needsImprovementSummary`: 需要改进的知识点摘要
- `weakSummary`: 薄弱知识点摘要

### 学习建议
- `recommendations`: 学习建议（中文）
- `recommendationsFr`: 学习建议（法语）

## 知识点分析标准

### Strong（掌握较好）
- 得分率 >= 80%
- 表现：熟练掌握了该知识点
- 建议：继续保持，可以挑战更高难度

### Needs Improvement（需要改进）
- 得分率 50% - 80%
- 表现：基本掌握，但有提升空间
- 建议：加强练习，查漏补缺

### Weak（薄弱环节）
- 得分率 < 50%
- 表现：需要重点加强
- 建议：重新学习，多做练习

## 使用示例

### JavaScript/Fetch
```javascript
const response = await fetch('http://localhost:8080/api/student-test/batch-submit', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    testRecordId: 1001,
    studentId: 123,
    answers: [
      { questionId: 501, studentAnswer: 'C', timeSpent: 30 },
      { questionId: 502, studentAnswer: 'A', timeSpent: 45 }
    ]
  })
});

const data = await response.json();
console.log('得分:', data.data.earnedPoints, '/', data.data.totalPoints);
console.log('得分率:', data.data.scoreRate, '%');

// 知识点分析
data.data.knowledgePointAnalysis.strongPoints.forEach(id => {
  console.log('掌握较好:', id);
});
```

### Vue.js
```vue
<template>
  <div class="test-analysis">
    <h2>测试结果</h2>
    <p>总分: {{ result.earnedPoints }} / {{ result.totalPoints }}</p>
    <p>得分率: {{ result.scoreRate }}%</p>
    
    <div class="knowledge-analysis">
      <h3>知识点分析</h3>
      
      <div class="strong-points">
        <h4>掌握较好</h4>
        <ul>
          <li v-for="score in strongPointScores" :key="score.knowledgePointId">
            {{ score.knowledgePointName }}: {{ score.scoreRate }}%
          </li>
        </ul>
      </div>
      
      <div class="needs-improvement">
        <h4>需要改进</h4>
        <ul>
          <li v-for="score in needsImprovementScores" :key="score.knowledgePointId">
            {{ score.knowledgePointName }}: {{ score.scoreRate }}%
          </li>
        </ul>
      </div>
      
      <div class="weak-points">
        <h4>薄弱环节</h4>
        <ul>
          <li v-for="score in weakPointScores" :key="score.knowledgePointId">
            {{ score.knowledgePointName }}: {{ score.scoreRate }}%
          </li>
        </ul>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  data() {
    return {
      result: null,
      answers: []
    }
  },
  computed: {
    strongPointScores() {
      if (!this.result) return [];
      return this.result.knowledgePointScores.filter(s => 
        this.result.knowledgePointAnalysis.strongPoints.includes(s.knowledgePointId)
      );
    },
    needsImprovementScores() {
      if (!this.result) return [];
      return this.result.knowledgePointScores.filter(s => 
        this.result.knowledgePointAnalysis.needsImprovementPoints.includes(s.knowledgePointId)
      );
    },
    weakPointScores() {
      if (!this.result) return [];
      return this.result.knowledgePointScores.filter(s => 
        this.result.knowledgePointAnalysis.weakPoints.includes(s.knowledgePointId)
      );
    }
  },
  methods: {
    async submitAnswers() {
      try {
        const response = await this.$http.post('/api/student-test/batch-submit', {
          testRecordId: this.testRecordId,
          studentId: this.studentId,
          answers: this.answers
        });
        
        if (response.data.code === 200) {
          this.result = response.data.data;
          this.$message.success('提交成功');
        }
      } catch (error) {
        this.$message.error('提交失败');
      }
    }
  }
}
</script>
```

## 数据流程

1. **接收批量答案** → 验证测试记录存在
2. **保存答案到 `student_test_answer`** → 计算单题得分
3. **统计总得分** → 计算总分、正确率、得分率
4. **统计各知识点得分** → 按知识点分组计算
5. **生成知识点分析** → 分类为 strong/needs improvement/weak
6. **生成总体评价** → 根据得分率给出评价
7. **生成学习建议** → 列出掌握情况和改进建议
8. **返回完整分析结果**

## 数据库更新

调用此接口后，以下表会被更新：

1. **student_test_answer** - 保存每个题目的答题详情
2. **student_test_record** - 更新测试记录状态、得分、时间等
3. **test_analysis_report** - 自动保存分析报告（包含知识点分析）

### 分析报告自动保存

接口调用成功后，系统会自动将完整的分析结果保存到 `test_analysis_report` 表中，包括：

- **测试基本信息**: 测试记录ID、学生ID、测试ID
- **总体统计**: 总分、获得分数、得分率、正确率
- **知识点分类**: 
  - `strong_knowledge_points` - 掌握较好的知识点ID列表（JSON数组）
  - `needs_improvement_points` - 需要改进的知识点ID列表（JSON数组）
  - `weak_knowledge_points` - 薄弱知识点ID列表（JSON数组）
- **分析摘要**: 
  - `strong_points_summary` - 掌握较好的知识点摘要
  - `needs_improvement_summary` - 需要改进的知识点摘要
  - `weak_points_summary` - 薄弱知识点摘要
- **学习建议**: 
  - `recommendations` - 学习建议（中文）
  - `recommendations_fr` - 学习建议（法语）

## 错误处理

### 测试记录不存在
```json
{
  "code": 500,
  "message": "提交失败: 测试记录不存在",
  "data": null
}
```

### 参数验证失败
```json
{
  "code": 500,
  "message": "测试记录ID不能为空",
  "data": null
}
```
