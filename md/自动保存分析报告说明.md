# 自动保存分析报告说明

## 功能概述

批量答题接口 (`/api/student-test/batch-submit`) 在学生提交答案后，**自动将完整的分析报告保存到数据库**，无需额外调用。

## 保存内容

### 1. 测试基本信息
```sql
test_record_id      -- 测试记录ID
student_id          -- 学生ID
test_id             -- 测试ID
report_type         -- 报告类型（1-分析报告）
report_title        -- 报告标题
report_title_fr     -- 报告标题（法语）
```

### 2. 总体统计
```sql
overall_score       -- 总体得分率
total_points        -- 总分
earned_points       -- 获得分数
accuracy_rate       -- 正确率
```

### 3. 知识点分类
```sql
strong_knowledge_points        -- 掌握较好的知识点ID列表（JSON: [1,5,9]）
needs_improvement_points      -- 需要改进的知识点ID列表（JSON: [15,16]）
weak_knowledge_points         -- 薄弱知识点ID列表（JSON: [22]）
```

### 4. 分析摘要
```sql
strong_points_summary          -- 掌握较好的知识点摘要
needs_improvement_summary      -- 需要改进的知识点摘要
weak_points_summary            -- 薄弱知识点摘要
```

### 5. 学习建议
```sql
recommendations                -- 学习建议（中文）
recommendations_fr             -- 学习建议（法语）
```

### 6. 完整JSON数据
```sql
analysis_data                  -- 完整分析数据（JSON格式）
report_content                 -- 报告内容（包含评价和建议的JSON）
```

## 数据库示例

### 保存后的数据示例

```sql
SELECT 
    id,
    test_record_id,
    student_id,
    report_title,
    overall_score,
    earned_points,
    total_points,
    accuracy_rate,
    strong_knowledge_points,
    needs_improvement_points,
    weak_knowledge_points,
    strong_points_summary,
    needs_improvement_summary,
    weak_points_summary,
    recommendations,
    analysis_data
FROM test_analysis_report
WHERE test_record_id = 1001;
```

**返回示例**:
```
id: 1
test_record_id: 1001
student_id: 123
report_title: "测试分析报告_1001"
overall_score: 80.00
earned_points: 24
total_points: 30
accuracy_rate: 83.33

strong_knowledge_points: "[1,5,9]"
needs_improvement_points: "[15,16]"
weak_knowledge_points: "[22]"

strong_points_summary: "Triangles, Quadratic Radicals, Pythagorean Theorem"
needs_improvement_summary: "Linear Functions, Graphs of Linear Functions"
weak_points_summary: "Applications of Linear Functions"

recommendations: "总体得分: 80.00%\n\n掌握较好: Triangles, Quadratic Radicals\n需要改进: Linear Functions\n薄弱环节: Applications of Linear Functions"

analysis_data: "{\"strongPoints\":[1,5,9],\"needsImprovementPoints\":[15,16],\"weakPoints\":[22],\"overallScore\":80.00}"
```

## 查询分析报告

### 1. 根据测试记录ID查询
```sql
SELECT * FROM test_analysis_report 
WHERE test_record_id = 1001 AND delete_flag = 'N';
```

### 2. 根据学生ID查询所有报告
```sql
SELECT * FROM test_analysis_report 
WHERE student_id = 123 AND delete_flag = 'N' 
ORDER BY create_at DESC;
```

### 3. 解析知识点ID列表
```javascript
// 解析JSON数组
const strongPoints = JSON.parse(analysisReport.strong_knowledge_points);
// 结果: [1, 5, 9]

const needsImprovement = JSON.parse(analysisReport.needs_improvement_points);
// 结果: [15, 16]

const weakPoints = JSON.parse(analysisReport.weak_knowledge_points);
// 结果: [22]
```

## 应用场景

### 1. 学生查看历史报告
```java
@GetMapping("/api/test-analysis/reports/{studentId}")
public RespResult<List<TestAnalysisReport>> getStudentReports(@PathVariable Integer studentId) {
    List<TestAnalysisReport> reports = testAnalysisReportMapper.findReportsByStudentId(studentId);
    return RespResult.success(reports);
}
```

### 2. 查看特定测试的分析报告
```java
@GetMapping("/api/test-analysis/report/{testRecordId}")
public RespResult<TestAnalysisReport> getAnalysisReport(@PathVariable Integer testRecordId) {
    TestAnalysisReport report = testAnalysisReportMapper.findByTestRecordId(testRecordId);
    return RespResult.success(report);
}
```

### 3. 生成学习路径建议
基于分析报告中的知识点分类，可以为学生推荐：
- **复习重点**: weak_knowledge_points
- **巩固练习**: needs_improvement_points  
- **拓展学习**: strong_knowledge_points

## 注意事项

1. **自动保存**: 每次调用批量答题接口，都会自动保存分析报告
2. **更新机制**: 如果同一测试记录已存在报告，会自动更新而不是重复插入
3. **逻辑删除**: 报告采用逻辑删除（delete_flag='Y'），历史数据可追溯
4. **数据完整性**: 保存的数据与API返回的数据完全一致

## 数据库脚本

确保数据库表结构包含所有增强字段：

```sql
-- 执行增强脚本
SOURCE create_test_analysis_report_enhanced.sql;

-- 验证字段
DESCRIBE test_analysis_report;
```

## 前端集成示例

```vue
<template>
  <div class="analysis-report">
    <h2>测试分析报告</h2>
    
    <!-- 总体得分 -->
    <div class="overall-score">
      <p>得分: {{ report.earned_points }} / {{ report.total_points }}</p>
      <p>得分率: {{ report.overall_score }}%</p>
      <p>正确率: {{ report.accuracy_rate }}%</p>
    </div>
    
    <!-- 知识点分析 -->
    <div class="knowledge-analysis">
      <div class="strong-points">
        <h3>掌握较好</h3>
        <p>{{ report.strong_points_summary }}</p>
      </div>
      
      <div class="needs-improvement">
        <h3>需要改进</h3>
        <p>{{ report.needs_improvement_summary }}</p>
      </div>
      
      <div class="weak-points">
        <h3>薄弱环节</h3>
        <p>{{ report.weak_points_summary }}</p>
      </div>
    </div>
    
    <!-- 学习建议 -->
    <div class="recommendations">
      <h3>学习建议</h3>
      <pre>{{ report.recommendations }}</pre>
    </div>
  </div>
</template>

<script>
export default {
  data() {
    return {
      report: null
    }
  },
  async mounted() {
    const testRecordId = this.$route.params.id;
    const response = await this.$http.get(`/api/test-analysis/report/${testRecordId}`);
    this.report = response.data.data;
  }
}
</script>
```
